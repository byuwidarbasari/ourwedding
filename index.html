<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>The Royal Wedding - PWA with Google Drive</title>
<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">
<!-- Theme color -->
<meta name="theme-color" content="#C5A059">
<!-- Base URL -->
<base href="/ourwedding/">
<style>
:root {
  --gold: #C5A059;
  --gold-light: #D4B47C;
  --cream: #F5F0E8;
  --dark: #0A0A0A;
  --dark-soft: #1E1E1E;
  --dark-card: #2A2A2A;
  --glass: rgba(255, 255, 255, 0.05);
  --glass-border: rgba(197, 160, 89, 0.15);
  
  --control-size: clamp(28px, 4vw, 38px);
  --logo-size: clamp(40px, 6vw, 60px);
  --logo-scale: 2;
  --font-small: clamp(12px, 3vw, 14px);
  --font-medium: clamp(16px, 4vw, 20px);
  --font-large: clamp(20px, 5vw, 24px);
  --font-xlarge: clamp(24px, 6vw, 42px);
  
  --running-height: clamp(60px, 10vh, 80px);
  --bottom-bar-height: calc(var(--control-size) + 30px);
  --date-bottom-pos: calc(var(--running-height) + var(--bottom-bar-height) + 10px);
  --date-bottom-pos-hidden: var(--running-height);
}

/* [SISIPKAN SEMUA CSS DARI KODE SEBELUMNYA DI SINI] */
/* ... semua CSS styling yang sudah kita buat ... */

/* Drive Status */
.drive-status {
  position: absolute;
  top: 10px;
  left: 10px;
  background: linear-gradient(135deg, rgba(0,0,0,0.6), rgba(0,0,0,0.4));
  backdrop-filter: blur(8px);
  color: var(--gold-light);
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 11px;
  border: 1px solid rgba(197,160,89,0.3);
  z-index: 50;
  pointer-events: none;
  display: flex;
  align-items: center;
  gap: 5px;
}

.drive-status.online { color: #4CAF50; }
.drive-status.offline { color: #ff9800; }
.drive-status.error { color: #f44336; }
</style>
</head>
<body>

<div class="stage">
  <div class="background-effects" id="backgroundEffects"></div>

  <!-- DRIVE STATUS - REAL, BUKAN DEMO -->
  <div class="drive-status" id="driveStatus">
    <span data-icon="folder"></span>
    <span id="driveStatusText">Menyiapkan...</span>
  </div>

  <!-- PWA Install Button -->
  <button class="install-btn hide" id="installBtn" title="Install App">
    <span data-icon="download">üì≤</span>
  </button>

  <!-- Online/Offline Indicator -->
  <div class="online-indicator" id="onlineIndicator">ONLINE</div>

  <!-- LOGO CORNERS -->
  <div class="logo-corner left" id="logoLeft">
    <div class="logo-placeholder" id="logoLeftPlaceholder">‚öúÔ∏è</div>
    <img id="logoLeftImg" src="" alt="Logo Kiri" style="display: none;">
  </div>
  
  <div class="logo-corner right" id="logoRight">
    <div class="logo-placeholder" id="logoRightPlaceholder">‚öúÔ∏è</div>
    <img id="logoRightImg" src="" alt="Logo Kanan" style="display: none;">
  </div>
  
  <div id="slidesContainer">
    <div class="empty-state" id="emptyState">
      <span data-icon="folder"></span>
      <h2>GOOGLE DRIVE</h2>
      <p>Folder ID: 1AU12HTGWX-i_zPw657R5GjV7IFimYM2A</p>
      <p>Mengakses file...</p>
      <div class="loading-spinner" style="margin-top: 20px;">
        <span data-icon="spinner"></span>
      </div>
    </div>
  </div>
  
  <div class="loading-indicator" id="loadingIndicator">
    <div><span data-icon="spinner"></span> LOADING MEDIA</div>
  </div>

  <div class="om-title" id="omTitle">
    <div class="om-text">OM SWASTYASTU</div>
  </div>

  <!-- DATETIME -->
  <div class="datetime-premium" id="datetime">
    <div class="day" id="day"></div>
    <div class="date" id="date"></div>
    <div class="time">
      <span class="hours-minutes" id="hoursMinutes"></span>
      <span class="seconds" id="seconds"></span>
    </div>
  </div>

  <!-- BOTTOM BAR -->
  <div class="bottom-bar" id="bottomBar">
    <button onclick="window.prevSlide()" title="Previous" id="prevBtn"><span data-icon="prev"></span></button>
    <button onclick="window.togglePlay()" id="playBtn" title="Play/Pause"><span data-icon="pause"></span></button>
    <button onclick="window.nextSlide()" title="Next" id="nextBtn"><span data-icon="next"></span></button>
    
    <div class="audio-control" id="audioControl">
      <button onclick="window.toggleAudio()" id="audioToggleBtn" title="Play/Pause MP3">
        <span data-icon="music"></span>
        <span id="audioBtnText">Play MP3</span>
      </button>
    </div>
    
    <button class="fullscreen-btn" id="fullscreenBtn" title="Fullscreen"><span data-icon="fullscreen"></span></button>
    <button class="settings-btn" id="settingsBtn" title="Settings"><span data-icon="settings"></span></button>
  </div>

  <!-- RUNNING TEXT -->
  <div class="running-box" id="runningBox">
    <div class="fade-left" id="fadeLeft"></div>
    <div class="fade-right" id="fadeRight"></div>
    <div class="running-content">
      <div class="running-track" id="runningTrack"></div>
    </div>
  </div>

  <!-- FOLDER INFO -->
  <div class="folder-info hide" id="folderInfo">
    <span data-icon="folder"></span> <span id="folderInfoText">GOOGLE DRIVE</span>
  </div>
  
  <!-- SETTINGS PANEL -->
  <div class="settings-panel hide" id="settingsPanel">
    <h3><span data-icon="settings"></span> PENGATURAN</h3>
    
    <div class="settings-section">
      <h4>‚òÅÔ∏è GOOGLE DRIVE</h4>
      <div class="setting-item">
        <span class="setting-label">Folder ID</span>
        <input type="text" class="setting-textarea" id="driveFolderId" value="1AU12HTGWX-i_zPw657R5GjV7IFimYM2A" style="height: 40px;">
        <button class="settings-btn-small" id="loadDriveBtn" style="margin-top:5px;width:100%;">üìÇ Load dari Google Drive</button>
      </div>
      <div class="setting-item">
        <span class="setting-label">Status</span>
        <span id="driveStatusDetail">Menunggu...</span>
      </div>
    </div>
    
    <!-- [SISIPKAN SEMUA SETTING LAINNYA DI SINI] -->
    <!-- Background, Animasi, Auto Hide, dll -->
    
    <div class="button-group">
      <button class="settings-btn-small save" id="saveSettings">üíæ Save</button>
      <button class="settings-btn-small" id="resetSettings">‚Ü∫ Reset</button>
      <button class="settings-btn-small" id="closeSettings">‚úï Close</button>
    </div>
  </div>
</div>

<div id="audioContainer"></div>

<script>
(function() {
  'use strict';
  
  // ===== KONFIGURASI GOOGLE DRIVE =====
  const DRIVE_FOLDER_ID = '1AU12HTGWX-i_zPw657R5GjV7IFimYM2A';
  
  // Anda HARUS membuat API Key sendiri di Google Cloud Console
  // Ini GRATIS dan mudah dibuat
  const API_KEY = 'AIzaSyAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'; // GANTI DENGAN API KEY ANDA
  
  // CORS Proxy - Untuk development, gunakan ini
  // Untuk production, lebih baik buat proxy sendiri
  const CORS_PROXY = 'https://cors-anywhere.herokuapp.com/';
  
  // Google Drive API endpoints
  const FILES_ENDPOINT = `https://www.googleapis.com/drive/v3/files`;
  
  // Status elements
  const driveStatus = document.getElementById('driveStatus');
  const driveStatusText = document.getElementById('driveStatusText');
  const driveStatusDetail = document.getElementById('driveStatusDetail');
  const emptyState = document.getElementById('emptyState');
  const container = document.getElementById('slidesContainer');
  const loadingIndicator = document.getElementById('loadingIndicator');
  
  // ===== CEK KONEKSI INTERNET =====
  function isOnline() {
    return navigator.onLine;
  }
  
  // ===== FUNGSI GOOGLE DRIVE - REAL =====
  async function listFilesInFolder(folderId) {
    if (!isOnline()) {
      driveStatusText.textContent = 'OFFLINE';
      driveStatusDetail.textContent = 'Tidak ada koneksi internet';
      driveStatus.classList.add('offline');
      return null;
    }
    
    try {
      driveStatusText.textContent = 'Mengakses Drive...';
      driveStatusDetail.textContent = 'Mengambil daftar file...';
      driveStatus.classList.remove('error', 'offline');
      driveStatus.classList.add('online');
      
      // Query files di folder
      const query = `'${folderId}' in parents and (mimeType contains 'image/' or mimeType contains 'video/' or mimeType contains 'audio/')`;
      const url = `${CORS_PROXY}${FILES_ENDPOINT}?q=${encodeURIComponent(query)}&key=${API_KEY}&fields=files(id,name,mimeType,size,webContentLink)&pageSize=100`;
      
      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (!data.files || data.files.length === 0) {
        driveStatusDetail.textContent = 'Tidak ada file media di folder';
        return { images: [], videos: [], audio: [] };
      }
      
      // Klasifikasikan file berdasarkan tipe
      const images = data.files.filter(f => f.mimeType.startsWith('image/'));
      const videos = data.files.filter(f => f.mimeType.startsWith('video/'));
      const audio = data.files.filter(f => f.mimeType.startsWith('audio/'));
      
      driveStatusDetail.textContent = `Ditemukan: ${images.length} gambar, ${videos.length} video, ${audio.length} audio`;
      
      return { images, videos, audio };
      
    } catch (error) {
      console.error('Error accessing Google Drive:', error);
      driveStatusText.textContent = 'ERROR';
      driveStatusDetail.textContent = error.message;
      driveStatus.classList.add('error');
      driveStatus.classList.remove('online');
      return null;
    }
  }
  
  // ===== LOAD MEDIA DARI GOOGLE DRIVE =====
  async function loadFromGoogleDrive(folderId = DRIVE_FOLDER_ID) {
    // Reset tampilan
    emptyState.classList.add('hide');
    container.innerHTML = "";
    loadingIndicator.classList.add("show");
    
    driveStatusText.textContent = 'Memuat...';
    
    // Ambil daftar file
    const files = await listFilesInFolder(folderId);
    
    if (!files) {
      loadingIndicator.classList.remove("show");
      emptyState.classList.remove('hide');
      emptyState.innerHTML = `
        <span data-icon="folder"></span>
        <h2>GAGAL AKSES DRIVE</h2>
        <p>Periksa koneksi internet atau Folder ID</p>
        <p style="font-size:12px; color:#ff9800;">Error: ${driveStatusDetail.textContent}</p>
        <button class="settings-btn-small" onclick="location.reload()" style="margin-top:20px;">Coba Lagi</button>
      `;
      return;
    }
    
    // Jika tidak ada file
    if (files.images.length === 0 && files.videos.length === 0) {
      loadingIndicator.classList.remove("show");
      emptyState.classList.remove('hide');
      emptyState.innerHTML = `
        <span data-icon="folder"></span>
        <h2>TIDAK ADA FILE MEDIA</h2>
        <p>Folder tidak mengandung gambar atau video</p>
      `;
      return;
    }
    
    driveStatusText.textContent = 'Memuat media...';
    
    // Gabungkan semua media (gambar dulu, lalu video)
    const allMedia = [...files.images, ...files.videos];
    
    // Buat slide untuk setiap file
    for (let i = 0; i < allMedia.length; i++) {
      const file = allMedia[i];
      const slide = document.createElement('div');
      slide.className = 'slide';
      
      if (file.mimeType.startsWith('image/')) {
        // Untuk gambar
        const img = document.createElement('img');
        img.className = 'main';
        
        // URL download dari Google Drive
        const imageUrl = `https://drive.google.com/uc?export=view&id=${file.id}`;
        img.src = imageUrl;
        img.alt = file.name;
        
        img.onerror = function() {
          console.error('Gagal memuat gambar:', file.name);
          this.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23333"/><text x="10" y="55" fill="%23C5A059" font-family="Arial" font-size="14">Error</text></svg>';
        };
        
        slide.appendChild(img);
        
      } else if (file.mimeType.startsWith('video/')) {
        // Untuk video
        const video = document.createElement('video');
        video.className = 'video-main';
        video.controls = false;
        video.loop = false;
        
        // URL download dari Google Drive
        const videoUrl = `https://drive.google.com/uc?export=download&id=${file.id}`;
        video.src = videoUrl;
        
        video.onerror = function() {
          console.error('Gagal memuat video:', file.name);
        };
        
        slide.appendChild(video);
      }
      
      container.appendChild(slide);
      
      // Update progress
      if ((i + 1) % 5 === 0 || i === allMedia.length - 1) {
        driveStatusDetail.textContent = `Memuat ${i + 1}/${allMedia.length}...`;
      }
    }
    
    const slides = document.querySelectorAll('.slide');
    
    // Update folder info
    const folderInfo = document.getElementById('folderInfo');
    const folderInfoText = document.getElementById('folderInfoText');
    folderInfo.classList.remove('hide');
    folderInfoText.innerHTML = `üìÅ Google Drive: ${files.images.length} gambar, ${files.videos.length} video, ${files.audio.length} audio`;
    
    loadingIndicator.classList.remove("show");
    driveStatusText.textContent = 'Siap';
    
    // Aktifkan slide pertama
    if (slides.length > 0) {
      slides[0].classList.add('active');
      window.slides = slides;
      window.currentSlide = 0;
      window.startSlideshow();
      
      // Terapkan animasi
      if (typeof window.applyAnimationToSlide === 'function') {
        window.applyAnimationToSlide(slides[0]);
      }
    }
    
    // Handle audio files
    if (files.audio.length > 0) {
      window.audioFiles = files.audio;
      document.getElementById('audioBtnText').textContent = 'Play MP3';
      initAudioPlayer();
      
      // Update playlist
      const playlistEl = document.getElementById('audioPlaylist');
      if (playlistEl) {
        playlistEl.innerHTML = files.audio.map(f => `<div>üéµ ${f.name}</div>`).join('');
      }
    }
  }
  
  // ===== AUDIO PLAYER UNTUK DRIVE =====
  function initAudioPlayer() {
    let audioPlayer = document.getElementById('dynamicAudio');
    if (!audioPlayer) {
      audioPlayer = document.createElement('audio');
      audioPlayer.id = 'dynamicAudio';
      audioPlayer.loop = false;
      document.getElementById('audioContainer').appendChild(audioPlayer);
      
      audioPlayer.addEventListener('play', () => {
        document.getElementById('audioBtnText').textContent = 'Pause';
        document.querySelector('#audioToggleBtn span[data-icon]').setAttribute('data-icon', 'volume-up');
      });
      
      audioPlayer.addEventListener('pause', () => {
        document.getElementById('audioBtnText').textContent = 'Play MP3';
        document.querySelector('#audioToggleBtn span[data-icon]').setAttribute('data-icon', 'music');
      });
      
      audioPlayer.addEventListener('ended', () => {
        if (window.audioFiles && window.audioFiles.length > 0) {
          window.currentAudioIndex = (window.currentAudioIndex + 1) % window.audioFiles.length;
          playAudioAtIndex(window.currentAudioIndex);
        }
      });
    }
    return audioPlayer;
  }
  
  function playAudioAtIndex(index) {
    const audioPlayer = document.getElementById('dynamicAudio') || initAudioPlayer();
    if (!window.audioFiles || window.audioFiles.length === 0) { 
      document.getElementById('audioBtnText').textContent = 'No MP3'; 
      return; 
    }
    
    const audioFile = window.audioFiles[index];
    const audioUrl = `https://drive.google.com/uc?export=download&id=${audioFile.id}`;
    
    audioPlayer.src = audioUrl;
    audioPlayer.volume = (window.bgVolume || 70) / 100;
    audioPlayer.play().catch(e => {
      console.error('Gagal memutar audio:', e);
      if (window.audioFiles.length > 0) {
        window.currentAudioIndex = (window.currentAudioIndex + 1) % window.audioFiles.length;
        playAudioAtIndex(window.currentAudioIndex);
      }
    });
  }
  
  // ===== EXPOSE FUNCTIONS =====
  window.toggleAudio = function() {
    const audioPlayer = document.getElementById('dynamicAudio') || initAudioPlayer();
    if (!window.audioFiles || window.audioFiles.length === 0) { 
      alert('Tidak ada file MP3 di Google Drive'); 
      return; 
    }
    
    if (audioPlayer.paused) {
      if (!audioPlayer.src) { 
        window.currentAudioIndex = 0; 
        playAudioAtIndex(0); 
      } else {
        audioPlayer.play();
      }
    } else {
      audioPlayer.pause();
    }
  };
  
  window.loadFromGoogleDrive = loadFromGoogleDrive;
  
  // ===== SERVICE WORKER REGISTRATION =====
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js')
        .then(reg => console.log('Service Worker registered:', reg.scope))
        .catch(err => console.log('Service Worker registration failed:', err));
    });
  }
  
  // ===== PWA INSTALL =====
  let deferredPrompt;
  const installBtn = document.getElementById('installBtn');
  const onlineIndicator = document.getElementById('onlineIndicator');

  function updateOnlineStatus() {
    if (navigator.onLine) {
      onlineIndicator.textContent = 'ONLINE';
      onlineIndicator.style.color = '#4CAF50';
    } else {
      onlineIndicator.textContent = 'OFFLINE';
      onlineIndicator.style.color = '#C5A059';
      driveStatusText.textContent = 'OFFLINE';
    }
  }

  window.addEventListener('online', updateOnlineStatus);
  window.addEventListener('offline', updateOnlineStatus);
  updateOnlineStatus();

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.classList.remove('hide');
  });

  installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') {
      installBtn.classList.add('hide');
    }
    deferredPrompt = null;
  });

  window.addEventListener('appinstalled', () => {
    installBtn.classList.add('hide');
    onlineIndicator.textContent = 'INSTALLED';
  });

  // ===== BASIC SLIDE FUNCTIONS =====
  window.slides = [];
  window.currentSlide = 0;
  window.autoPlay = true;
  window.audioFiles = [];
  window.currentAudioIndex = 0;
  window.bgVolume = 70;
  
  window.nextSlide = function() {
    if (!window.slides || window.slides.length === 0) return;
    
    // Pause semua video
    document.querySelectorAll('video').forEach(v => v.pause());
    
    window.slides[window.currentSlide]?.classList.remove("active");
    window.currentSlide = (window.currentSlide + 1) % window.slides.length;
    window.slides[window.currentSlide]?.classList.add("active");
    
    // Play video jika ada
    const video = window.slides[window.currentSlide]?.querySelector('video');
    if (video) {
      video.play();
    }
    
    // Terapkan animasi
    if (typeof window.applyAnimationToSlide === 'function') {
      window.applyAnimationToSlide(window.slides[window.currentSlide]);
    }
  };
  
  window.prevSlide = function() {
    if (!window.slides || window.slides.length === 0) return;
    
    document.querySelectorAll('video').forEach(v => v.pause());
    
    window.slides[window.currentSlide]?.classList.remove("active");
    window.currentSlide = (window.currentSlide - 1 + window.slides.length) % window.slides.length;
    window.slides[window.currentSlide]?.classList.add("active");
    
    const video = window.slides[window.currentSlide]?.querySelector('video');
    if (video) {
      video.play();
    }
    
    if (typeof window.applyAnimationToSlide === 'function') {
      window.applyAnimationToSlide(window.slides[window.currentSlide]);
    }
  };
  
  window.togglePlay = function() {
    window.autoPlay = !window.autoPlay;
    const playBtn = document.getElementById('playBtn');
    playBtn.querySelector('span[data-icon]').setAttribute('data-icon', window.autoPlay ? 'pause' : 'play');
    
    if (window.autoPlay) {
      window.startSlideshow();
      const video = window.slides[window.currentSlide]?.querySelector('video');
      if (video) video.play();
    } else {
      if (window.slideTimeout) clearTimeout(window.slideTimeout);
      document.querySelectorAll('video').forEach(v => v.pause());
    }
  };
  
  window.startSlideshow = function() {
    if (!window.autoPlay || !window.slides || window.slides.length === 0) return;
    if (window.slideTimeout) clearTimeout(window.slideTimeout);
    window.slideTimeout = setTimeout(window.nextSlide, 8000);
  };
  
  // ===== ANIMASI SLIDE =====
  const allAnimations = [
    'anim-zoom-in', 'anim-zoom-out', 'anim-shatter', 'anim-from-all',
    'anim-slide-left', 'anim-slide-right', 'anim-slide-top', 'anim-slide-bottom',
    'anim-fade-rotate', 'anim-blur-in', 'anim-bounce', 'anim-flip'
  ];
  
  window.applyAnimationToSlide = function(slideElement) {
    const img = slideElement?.querySelector('.main');
    if (!img) return;
    
    allAnimations.forEach(cls => img.classList.remove(cls));
    
    // Random animation
    const randomAnim = allAnimations[Math.floor(Math.random() * allAnimations.length)];
    img.classList.add(randomAnim);
    img.style.animationDuration = '8s';
  };
  
  // ===== SETTINGS =====
  document.getElementById('settingsBtn').addEventListener('click', () => {
    document.getElementById('settingsPanel').classList.toggle('hide');
  });
  
  document.getElementById('closeSettings').addEventListener('click', () => {
    document.getElementById('settingsPanel').classList.add('hide');
  });
  
  document.getElementById('loadDriveBtn').addEventListener('click', () => {
    const folderId = document.getElementById('driveFolderId').value;
    loadFromGoogleDrive(folderId);
  });
  
  // Fullscreen
  document.getElementById('fullscreenBtn').addEventListener('click', () => {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen();
    } else {
      document.exitFullscreen();
    }
  });
  
  // Tanggal
  function updateDateTime() {
    const now = new Date();
    const days = ['MINGGU','SENIN','SELASA','RABU','KAMIS','JUMAT','SABTU'];
    const months = ['JANUARI','FEBRUARI','MARET','APRIL','MEI','JUNI','JULI','AGUSTUS','SEPTEMBER','OKTOBER','NOVEMBER','DESEMBER'];
    document.getElementById('day').textContent = days[now.getDay()];
    document.getElementById('date').textContent = `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
    document.getElementById('hoursMinutes').textContent = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    document.getElementById('seconds').textContent = String(now.getSeconds()).padStart(2,'0');
  }
  setInterval(updateDateTime, 1000);
  updateDateTime();
  
  // Auto load saat halaman dimuat
  setTimeout(() => {
    if (isOnline()) {
      loadFromGoogleDrive();
    } else {
      emptyState.innerHTML = `
        <span data-icon="folder"></span>
        <h2>OFFLINE MODE</h2>
        <p>Tidak ada koneksi internet</p>
        <p>Gunakan tombol folder untuk upload lokal</p>
      `;
    }
  }, 1500);
  
  console.log('‚úÖ PWA Ready - Google Drive Integration');
})();
</script>
</body>
</html>
